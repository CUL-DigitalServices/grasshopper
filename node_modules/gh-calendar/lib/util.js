/**
 * Copyright (c) 2015 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _ = require('lodash');
var util = require('util');
var VCalendar = require('cozy-ical').VCalendar;
var VEvent = require('cozy-ical').VEvent;
var VTodo = require('cozy-ical').VTodo;
var xmlescape = require('xml-escape');

var DB = require('gh-core/lib/db');

/**
 * Format a set of events into an iCalendar feed
 *
 * @param  {CalendarInfo}       calendarInfo            More information about the calendar
 * @param  {Object[]}           events                  A subset of event data, depending on what the consumer decided to provide
 * @param  {Number}             events.id               The id of the event
 * @param  {String}             events.start            The timestamp (ISO 8601) at which the event starts
 * @param  {String}             events.end              The timestamp (ISO 8601) at which the event ends
 * @param  {String}             events.createdAt        The timestamp (ISO 8601) at which the event was created
 * @param  {String}             [events.updatedAt]      The timestamp (ISO 8601) at which the event was last updated
 * @param  {String}             [events.location]       The location of the event
 * @param  {String}             [events.type]           The type of the event
 * @param  {String[]|User[]}    [events.organisers]     The organiser(s) of the event, if any
 * @param  {String}             [events.description]    The description of the event
 * @param  {String}             [events.notes]          The general notes of the event
 * @return {String}                                     The iCalendar feed
 */
var eventsToICal = module.exports.eventsToICal = function(calendarInfo, events) {
    // Construct a calendar
    var calendar = new VCalendar({
        'organization': calendarInfo.organisation,
        'title': calendarInfo.displayName
    });

    // Convert each Grasshopper event to an ical VEvent and add it to the calendar
    _.each(events, function(event) {
        // Convert the event to a JSON object if a sequelize event was provided
        if (event instanceof DB.Event.Instance) {
            event = event.toJSON();
        }

        // The description of the iCal event is a concatenation of:
        //  - The type
        //  - The organisers
        //  - The notes
        // As all of these fields are optional we need to ensure we don't end up with
        // stringified `null` entries or blank lines
        var description = '';

        // Only add the type if there is one
        if (event.type) {
            description += event.type;
        }

        // Only add organisers if there are any
        if (!_.isEmpty(event.organisers)) {
            var organisers = _.chain(event.organisers)
                .map(function(organiser) {
                    if (_.isString(organiser)) {
                        return organiser;
                    } else {
                        return organiser.displayName;
                    }
                })
                .sort()
                .value()
                .join(', ');
            description += ' with ' + organisers;
        }

        // Only add the description if there is one
        if (event.description) {
            description += '\n' + event.description;
        }

        // Only add events notes if there are any
        if (event.notes) {
            description += '\n\n' + event.notes;
        }

        // Trim any leading or trailing white space
        description = description.trim();

        var vevent = new VEvent({
            'startDate': event.start,
            'endDate': event.end,
            'created': event.createdAt,
            'stampDate': event.updatedAt,
            'summary': event.displayName,
            'description': description,
            'location': event.location,
            'uid': event.id
        });
        calendar.add(vevent);
    });

    // Return the calendar
    return calendar.toString();
};

/**
 * Format a set of events into an RSS feed
 *
 * @param  {CalendarInfo}   calendarInfo    More information about the calendar
 * @param  {Event[]}        events          The events that should be in the RSS feed
 * @return {String}                         The RSS feed
 */
var eventsToRSS = module.exports.eventsToRSS = function(calendarInfo, events) {
    var header = [
        '<rss version="2.0" xmlns:cf="http://www.microsoft.com/schemas/rss/core/2005" ',
            'xmlns:ev="http://purl.org/rss/1.0/modules/event/">',
        '<channel>'
    ];
    var calendar = [
        '<cf:treatAs>list</cf:treatAs>',
        '<cf:listinfo>',
        '<cf:sort ns="http://purl.org/rss/1.0/modules/event/" element="startdate" data-type="date" label="Start time" default="true"/>',
        '</cf:listinfo>',
        '<title>', _xmlescape(calendarInfo.displayName), '</title>',
        '<link>', _xmlescape(calendarInfo.link), '</link>',
        '<managingEditor>', _xmlescape(calendarInfo.editor), '</managingEditor>',
        '<pubDate>', _xmlescape(_formatRSSDate(calendarInfo.lastModified)), '</pubDate>',
        '<description>', _xmlescape(calendarInfo.description), '</description>'
    ];

    events = _.map(events, function(event) {
        // Convert the event to a JSON object if a sequelize event was provided
        if (event instanceof DB.Event.Instance) {
            event = event.toJSON();
        }

        var organisers = _.chain(event.organisers)
            .map(function(organiser) {
                if (_.isString(organiser)) {
                    return organiser;
                } else {
                    return organiser.displayName;
                }
            })
            .compact()
            .sort()
            .value()
            .join(', ');

        var eventRSS = [
            '<item>',
                '<title>', _xmlescape(event.displayName), '</title>',
                '<description>', _xmlescape(event.description), '</description>',
                '<pubDate>', _xmlescape(_formatRSSDate(event.lastModified)), '</pubDate>',
                '<link>', _xmlescape(_createRSSLink(calendarInfo, event)), '</link>',
                '<guid>', _xmlescape(_createRSSLink(calendarInfo, event)), '</guid>',
                '<ev:startdate>',_xmlescape(_formatRSSDate(event.start)), '</ev:startdate>',
                '<ev:enddate>', _xmlescape(_formatRSSDate(event.end)), '</ev:enddate>',
                '<ev:location>', _xmlescape(event.location), '</ev:location>',
                '<ev:organizer>', _xmlescape(organisers), '</ev:organizer>',
            '</item>'
        ];
        return eventRSS.join('');
    });

    var footer = ['</channel>', '</rss>'];

    var rss = header.join('');
    rss += calendar.join('');
    rss += events.join('');
    rss += footer.join('');
    return rss;
};

/**
 * XML Escape a given string. If no string was defined, the empty string will be returned
 *
 * @param  {String}     str     The string to XML escape
 * @return {String}             The escaped string
 * @api private
 */
var _xmlescape = function(str) {
    if (!str) {
        return '';
    }

    return xmlescape(str);
};

/**
 * Create a link for an event
 *
 * @param  {CalendarInfo}   calendarInfo    The info object for the calendar
 * @param  {Event}          event           The event for which to create the link
 * @return {String}                         A link for the event
 * @api private
 */
var _createRSSLink = function(calendarInfo, event) {
    return 'https://' + calendarInfo.app.host + '/events/' + event.id;
};

/**
 * Returns an RFC 822 compliant datetime string
 *
 * @param  {Date}       date    The date to format
 * @return {String}             The RFC 822 formatted timestamp
 * @api private
 */
var _formatRSSDate = function(date) {
    if (!date) {
        return '';
    }

    return date.toUTCString();
};
