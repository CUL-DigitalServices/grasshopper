/**
 * Copyright (c) 2015 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _ = require('lodash');
var assert = require('assert');
var moment = require('moment');

var EventsTestUtil = require('gh-events/tests/util');
var TestsUtil = require('gh-tests');

var SeriesTestsUtil = require('./util');

describe('Series - calendar', function() {

    describe('JSON', function() {

        /**
         * Test that verifies that a series calendar can be retrieved as JSON
         */
        it('verify a series calendar can be retrieved as JSON', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestsUtil.generateSerieWithEvents(simon.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Get the calendar
                    SeriesTestsUtil.assertGetSeriesCalendar(simon.client, serie.id, calendarStart, calendarEnd, serie.events, function() {

                        // Verify date filtering by generating a window that should contain no events
                        var rangeStart = moment().subtract(10, 'day').format();
                        var rangeEnd = moment().subtract(5, 'day').format();
                        SeriesTestsUtil.assertGetSeriesCalendar(simon.client, serie.id, rangeStart, rangeEnd, [], function() {

                            // Verify date filtering by generating a window that contains the first event
                            rangeStart = serie.events[0].start;
                            rangeEnd = serie.events[0].end;

                            // Because the events are generated randomly, it's possible that there is a second (or third)
                            // event that's in the range of the first event. To avoid intermittent failures we select all
                            // the events that happen in this range
                            var expectedEvents = _.filter(serie.events, function(event) {
                                return (event.start >= rangeStart && event.end <= rangeEnd);
                            });
                            SeriesTestsUtil.assertGetSeriesCalendar(simon.client, serie.id, rangeStart, rangeEnd, expectedEvents, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when retrieving a series calendar as JSON
         */
        it('verify validation when retrieving a series calendar as JSON', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a test serie
                SeriesTestsUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    // Create a test serie on another application
                    SeriesTestsUtil.assertCreateSerie(global.tests.admins.oxford2014.client, 'Test serie', null, function(oxfordSerie) {

                        var calendarStart = moment().subtract(1, 'day').format();
                        var calendarEnd = moment().add(30, 'day').format();

                        // Invalid serie id
                        SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, 'Not a number', calendarStart, calendarEnd, 400, function() {

                            // Unknown serie id
                            SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, -1, calendarStart, calendarEnd, 404, function() {

                                // A serie on another application
                                SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, -1, calendarStart, calendarEnd, 404, function() {

                                    // Missing start date
                                    SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, serie.id, null, calendarEnd, 400, function() {

                                        // Invalid start date
                                        SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, serie.id, 'invalid', calendarEnd, 400, function() {

                                            // Missing end date
                                            SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, serie.id, calendarStart, null, 400, function() {

                                                // Invalid end date
                                                SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, serie.id, calendarStart, 'invalid', 400, function() {

                                                    // End date before start date
                                                    SeriesTestsUtil.assertGetSeriesCalendarFails(simon.client, serie.id, calendarEnd, calendarStart, 400, function() {
                                                        return callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('RSS', function() {

        /**
         * Test that verifies that a series calendar can be retrieved as RSS
         */
        it('verify a series calendar can be retrieved as RSS', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestsUtil.generateSerieWithEvents(simon.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Get the calendar
                    SeriesTestsUtil.assertGetSeriesCalendarRss(simon.client, serie.id, calendarStart, calendarEnd, serie.events, function(calendar) {

                        // Verify date filtering by generating a window that should contain no events
                        var rangeStart = moment().subtract(10, 'day').format();
                        var rangeEnd = moment().subtract(5, 'day').format();
                        SeriesTestsUtil.assertGetSeriesCalendarRss(simon.client, serie.id, rangeStart, rangeEnd, [], function(calendar) {

                            // Verify date filtering by generating a window that contains the first event
                            rangeStart = serie.events[0].start;
                            rangeEnd = serie.events[0].end;

                            // Because the events are generated randomly, it's possible that there is a second (or third)
                            // event that's in the range of the first event. To avoid intermittent failures we select all
                            // the events that happen in this range
                            var expectedEvents = _.filter(serie.events, function(event) {
                                return (event.start >= rangeStart && event.end <= rangeEnd);
                            });
                            SeriesTestsUtil.assertGetSeriesCalendarRss(simon.client, serie.id, rangeStart, rangeEnd, expectedEvents, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when retrieving a series calendar as RSS
         */
        it('verify validation when retrieving a series calendar as RSS', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a test serie
                SeriesTestsUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    // Create a test serie on another application
                    SeriesTestsUtil.assertCreateSerie(global.tests.admins.oxford2014.client, 'Test serie', null, function(oxfordSerie) {

                        var calendarStart = moment().subtract(1, 'day').format();
                        var calendarEnd = moment().add(30, 'day').format();

                        // Invalid serie id
                        SeriesTestsUtil.assertGetSeriesCalendarRssFails(simon.client, 'Not a number', calendarStart, calendarEnd, 400, function() {

                            // Unknown serie id
                            SeriesTestsUtil.assertGetSeriesCalendarRssFails(simon.client, -1, calendarStart, calendarEnd, 404, function() {

                                // A serie from another application
                                SeriesTestsUtil.assertGetSeriesCalendarRssFails(simon.client, oxfordSerie.id, calendarStart, calendarEnd, 401, function() {

                                    // Invalid start date
                                    SeriesTestsUtil.assertGetSeriesCalendarRssFails(simon.client, serie.id, 'invalid', calendarEnd, 400, function() {

                                        // Invalid end date
                                        SeriesTestsUtil.assertGetSeriesCalendarRssFails(simon.client, serie.id, calendarStart, 'invalid', 400, function() {

                                            // End date before start date
                                            SeriesTestsUtil.assertGetSeriesCalendarRssFails(simon.client, serie.id, calendarEnd, calendarStart, 400, function() {
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('iCal', function() {

        /**
         * Test that verifies that a series calendar can be retrieved as iCal
         */
        it('verify a series calendar can be retrieved as iCal', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestsUtil.generateSerieWithEvents(simon.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Get the calendar
                    SeriesTestsUtil.assertGetSeriesCalendarIcal(simon.client, serie.id, calendarStart, calendarEnd, serie.events, function() {

                        // Verify date filtering by generating a window that should contain no events
                        var rangeStart = moment().subtract(10, 'day').format();
                        var rangeEnd = moment().subtract(5, 'day').format();
                        SeriesTestsUtil.assertGetSeriesCalendarIcal(simon.client, serie.id, rangeStart, rangeEnd, [], function() {

                            // Verify date filtering by generating a window that contains the first event
                            rangeStart = serie.events[0].start;
                            rangeEnd = serie.events[0].end;

                            // Because the events are generated randomly, it's possible that there is a second (or third)
                            // event that's in the range of the first event. To avoid intermittent failures we select all
                            // the events that happen in this range
                            var expectedEvents = _.filter(serie.events, function(event) {
                                return (event.start >= rangeStart && event.end <= rangeEnd);
                            });
                            SeriesTestsUtil.assertGetSeriesCalendarIcal(simon.client, serie.id, rangeStart, rangeEnd, expectedEvents, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when retrieving a series calendar as iCal
         */
        it('verify validation when retrieving a series calendar as iCal', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a test serie
                SeriesTestsUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    // Create a test serie on another application
                    SeriesTestsUtil.assertCreateSerie(global.tests.admins.oxford2014.client, 'Test serie', null, function(oxfordSerie) {

                        var calendarStart = moment().subtract(1, 'day').format();
                        var calendarEnd = moment().add(30, 'day').format();

                        // Invalid serie id
                        SeriesTestsUtil.assertGetSeriesCalendarIcalFails(simon.client, 'Not a number', null, null, 400, function() {

                            // Unknown serie id
                            SeriesTestsUtil.assertGetSeriesCalendarIcalFails(simon.client, -1, null, null, 404, function() {

                                // A serie from another application
                                SeriesTestsUtil.assertGetSeriesCalendarIcalFails(simon.client, oxfordSerie.id, null, null, 401, function() {

                                    // Invalid start date
                                    SeriesTestsUtil.assertGetSeriesCalendarIcalFails(simon.client, serie.id, 'invalid', calendarEnd, 400, function() {

                                        // Invalid end date
                                        SeriesTestsUtil.assertGetSeriesCalendarIcalFails(simon.client, serie.id, calendarStart, 'invalid', 400, function() {

                                            // End date before start date
                                            SeriesTestsUtil.assertGetSeriesCalendarIcalFails(simon.client, serie.id, calendarEnd, calendarStart, 400, function() {
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
