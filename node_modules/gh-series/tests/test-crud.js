/**
 * Copyright (c) 2014 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var assert = require('assert');

var OrgUnitTestUtil = require('gh-orgunit/tests/util');
var TestsUtil = require('gh-tests');

var SeriesTestUtil = require('./util');

describe('Series', function() {

    describe('Create serie', function() {

        /**
         * Test that verifies that a new serue can be created
         */
        it('verify create serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Verify creating a basic serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(createdSerie) {

                    // Verify creating a serie with more metadata
                    var opts = {
                        'app': global.tests.apps.cam2013.id,
                        'description': 'bladiebla'
                    };
                    SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', opts, function(createdSerie) {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies validation for creating series
         */
        it('verify create serie validation', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Missing displayName
                var opts = {};
                SeriesTestUtil.assertCreateSerieFails(simon.client, null, opts, 400, function() {

                    // Too long displayName
                    SeriesTestUtil.assertCreateSerieFails(simon.client, TestsUtil.generateString(257), opts, 400, function() {

                        // Too long description
                        opts = {'description': TestsUtil.generateString(1001)};
                        SeriesTestUtil.assertCreateSerieFails(simon.client, 'Test serie', opts, 400, function() {

                            // Invalid group id
                            opts = {'group': 'not a number'};
                            SeriesTestUtil.assertCreateSerieFails(simon.client, 'Test serie', opts, 400, callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization for creating series
         */
        it('verify create serie authorization', function(callback) {
            // Anonymous users cannot create a serie
            TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2013, function(anonymousClient) {
                SeriesTestUtil.assertCreateSerieFails(anonymousClient, 'Test serie', null, 401, function() {

                    // Regular users have to stick to creating series on their own tenant
                    TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {
                        var opts = {'app': global.tests.apps.oxford2014.id};
                        SeriesTestUtil.assertCreateSerieFails(simon.client, 'Test serie', opts, 401, callback);
                    });
                });
            });
        });
    });

    describe('Getting a serie', function() {

        /**
         * Test that verifies that a serie can be retrieved
         */
        it('verify getting a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(createdSerie) {

                    // Verify getting the serie
                    SeriesTestUtil.assertGetSerie(simon.client, createdSerie.id, createdSerie, function(serie) {
                        SeriesTestUtil.assertSerie(serie, createdSerie);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies validation for retrieving a serie
         */
        it('verify getting a serie validation', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Invalid serie id
                SeriesTestUtil.assertGetSerieFails(simon.client, 'not a number', 400, function() {

                    // Unknown serie id
                    SeriesTestUtil.assertGetSerieFails(simon.client, -1, 404, function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies authorization for a serie
         */
        it('verify getting a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {
                TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(nico) {

                    // Create a serie on the 2013 app
                    SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(createdSerie) {

                        // Assert that it can't be retrieved on the 2014 app
                        SeriesTestUtil.assertGetSerieFails(nico.client, createdSerie.id, 401, function() {

                            // Assert a global admin can retrieve it
                            TestsUtil.getGlobalAdminRestClient(function(adminClient) {
                                SeriesTestUtil.assertGetSerie(adminClient, createdSerie.id, createdSerie, function(retrievedSerie) {
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Updating a serie', function() {

        /**
         * Test that verifies that a serie can be updated
         */
        it('verify updating a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(createdSerie) {

                    // Update it
                    var update = {'displayName': 'Updated serie'};
                    SeriesTestUtil.assertUpdateSerie(simon.client, createdSerie.id, update, function(updatedSerie) {

                        // Retrieve it
                        SeriesTestUtil.assertGetSerie(simon.client, createdSerie.id, updatedSerie, function(retrievedSerie) {
                            return callback();
                        });
                    });
                });
            });            
        });

        /**
         * Test that verifies the validation for updating a serie
         */
        it('verify updating a serie validation', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    // No updates
                    var update = {};
                    SeriesTestUtil.assertUpdateSerieFails(simon.client, serie.id, update, 400, function() {

                        // Too long displayName
                        update = {'displayName': TestsUtil.generateString(257)};
                        SeriesTestUtil.assertUpdateSerieFails(simon.client, serie.id, update, 400, function() {

                            // Too long description
                            update = {'description': TestsUtil.generateString(1001)};
                            SeriesTestUtil.assertUpdateSerieFails(simon.client, serie.id, update, 400, function() {

                                // Invalid group id
                                update = {'group': 'not a number'};
                                SeriesTestUtil.assertUpdateSerieFails(simon.client, serie.id, update, 400, function() {

                                    // Unknown group id
                                    update = {'group': -1};
                                    SeriesTestUtil.assertUpdateSerieFails(simon.client, serie.id, update, 404, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the authorization for a serie update
         */
        it('verify updating a serie authorization', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(simon, nico) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    var update = {'displayName': 'foo'};

                    // Anonymous users cannot update a serie
                    TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2013, function(anonymousClient) {
                        SeriesTestUtil.assertUpdateSerieFails(anonymousClient, serie.id, update, 401, function() {
                            TestsUtil.getAnonymousGlobalAdminRestClient(function(anonymousGlobalClient) {
                                SeriesTestUtil.assertUpdateSerieFails(anonymousGlobalClient, serie.id, update, 401, function() {

                                    // Unrelated authenticated users cannot update a serie
                                    SeriesTestUtil.assertUpdateSerieFails(nico.client, serie.id, update, 401, function() {

                                        // Application admins from another application cannot update a serie
                                        SeriesTestUtil.assertUpdateSerieFails(global.tests.admins.cam2014.client, serie.id, update, 401, function() {

                                            // Members of the serie's group can update the serie
                                            SeriesTestUtil.assertUpdateSerie(simon.client, serie.id, update, function() {

                                                // Global admins can update a serie
                                                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie 2', null, function(serie2) {
                                                    TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                                        SeriesTestUtil.assertUpdateSerie(globalAdminClient, serie2.id, update, function(updatedSerie) {
                                                            return callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that an existing group can be used when updating a serie
         */
        it('verify an existing group can be used when updating a serie', function(callback) {
            // Create a test serie
            SeriesTestUtil.assertCreateSerie(global.tests.admins.cam2013.client, 'Test serie', null, function(serie) {

                // Verify a group from another application cannot be used
                OrgUnitTestUtil.assertCreateOrgUnit(global.tests.admins.cam2014.client, 'Test org unit', 'course', null, function(otherAppOrgUnit) {
                    var update = {'group': otherAppOrgUnit.GroupId};
                    SeriesTestUtil.assertUpdateSerieFails(global.tests.admins.cam2013.client, serie.id, update, 401, function() {

                        // A group from the same application can be used
                        OrgUnitTestUtil.assertCreateOrgUnit(global.tests.admins.cam2013.client, 'Test org unit', 'course', null, function(orgUnit) {
                            update = {'group': orgUnit.GroupId};
                            SeriesTestUtil.assertUpdateSerie(global.tests.admins.cam2013.client, serie.id, update, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Deleting a serie', function() {

        /**
         * Test that verifies that a serie can be deleted
         */
        it('verify deleting a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(createdSerie) {

                    // Delete it
                    SeriesTestUtil.assertDeleteSerie(simon.client, createdSerie.id, function() {

                        // Sanity-check it has been removed
                        SeriesTestUtil.assertGetSerieFails(simon.client, createdSerie.id, 404, callback);
                    });
                });
            });            
        });

        /**
         * Test that verifies the validation for deleted a serie
         */
        it('verify deleting a serie validation', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    // Invalid serie id
                    SeriesTestUtil.assertDeleteSerieFails(simon.client, 'not a number', 400, function() {

                        // Unknown serie id
                        SeriesTestUtil.assertDeleteSerieFails(simon.client, 'not a number', 400, function() {

                            // Sanity-check the serie still exists
                            SeriesTestUtil.assertGetSerie(simon.client, serie.id, serie, function(serie) {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the authorization for a serie update
         */
        it('verify updating a serie authorization', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(simon, nico) {

                // Create a serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', null, function(serie) {

                    // Anonymous users cannot delete a serie
                    TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2013, function(anonymousClient) {
                        SeriesTestUtil.assertDeleteSerieFails(anonymousClient, serie.id, 401, function() {
                            TestsUtil.getAnonymousGlobalAdminRestClient(function(anonymousGlobalClient) {
                                SeriesTestUtil.assertDeleteSerieFails(anonymousGlobalClient, serie.id, 401, function() {

                                    // Unrelated authenticated users cannot delete a serie
                                    SeriesTestUtil.assertDeleteSerieFails(nico.client, serie.id, 401, function() {

                                        // Application admins from another application cannot delete a serie
                                        SeriesTestUtil.assertDeleteSerieFails(global.tests.admins.cam2014.client, serie.id, 401, function() {

                                            // Members of the serie's group can delete the serie
                                            SeriesTestUtil.assertDeleteSerie(simon.client, serie.id, function() {

                                                // Global admins can delete a serie
                                                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie 2', null, function(serie2) {
                                                    TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                                        SeriesTestUtil.assertDeleteSerie(globalAdminClient, serie2.id, callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
