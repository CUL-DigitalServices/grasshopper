/**
 * Copyright (c) 2014 "Fronteer LTD"
 * Grasshopper Serie Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _ = require('lodash');
var assert = require('assert');
var moment = require('moment');

var EventsTestsUtil = require('gh-events/tests/util');
var TestsUtil = require('gh-tests');
var UsersTestsUtil = require('gh-users/tests/util');

var SeriesTestUtil = require('./util');

describe('Series', function() {

    describe('Subscribing', function() {

        /**
         * Test that verifies that a user can subscribe to a serie
         */
        it('verify a user can subscribe to a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestUtil.generateSerieWithEvents(serieCreator.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Subscribe to the serie
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, serieSubscriber.profile.id, function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies validation when a user subscribes to a serie
         */
        it('verify validation when a user subscribes to a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {


                // Generate a test serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', {}, function(serie) {

                    // Invalid serie id
                    SeriesTestUtil.assertSubscribeSeriesFails(simon.client, 'Not a number', simon.profile.id, 400, function() {

                        // Unknown serie id
                        SeriesTestUtil.assertSubscribeSeriesFails(simon.client, -1, simon.profile.id, 404, function() {
                            SeriesTestUtil.assertSubscribeSeriesFails(simon.client, 234234234234, simon.profile.id, 404, function() {

                                // Invalid user id
                                SeriesTestUtil.assertSubscribeSeriesFails(simon.client, serie.id, 'Not a number', 400, function() {

                                    // Unknown user id
                                    SeriesTestUtil.assertSubscribeSeriesFails(simon.client, serie.id, -1, 404, function() {
                                        SeriesTestUtil.assertSubscribeSeriesFails(simon.client, serie.id, 234242423423, 404, function() {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when a user subscribes to a serie
         */
        it('verify authorization when a user subscribes to a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(camUser, anotherCamUser) {
                TestsUtil.generateTestUsers(global.tests.apps.oxford2014, 1, false, function(oxfordUser) {

                    // Generate a test serie with some events on the cambridge app
                    var calendarStart = moment().subtract(1, 'day').format();
                    var calendarEnd = moment().add(30, 'day').format();
                    SeriesTestUtil.generateSerieWithEvents(camUser.client, 3, 10, calendarStart, calendarEnd, function(series) {
                        var serie = series[0];

                        // Anonymous users cannot subscribe to a serie
                        TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2013, function(anonymousClient) {
                            SeriesTestUtil.assertSubscribeSeriesFails(anonymousClient, serie.id, camUser.profile.id, 401, function() {

                                // Users cannot subscribe to a serie from another app
                                SeriesTestUtil.assertSubscribeSeriesFails(oxfordUser.client, serie.id, oxfordUser.profile.id, 401, function() {

                                    // Users cannot subscribe other users
                                    SeriesTestUtil.assertSubscribeSeriesFails(camUser.client, serie.id, anotherCamUser.profile.id, 401, function() {
                                        SeriesTestUtil.assertSubscribeSeriesFails(camUser.client, serie.id, oxfordUser.profile.id, 401, function() {

                                            // App admins can subscribe users
                                            SeriesTestUtil.assertSubscribeSeries(global.tests.admins.cam2013.client, series[1].id, camUser.profile.id, function() {

                                                // App admins cannot subscribe users from other applications
                                                SeriesTestUtil.assertSubscribeSeriesFails(global.tests.admins.cam2013.client, series[1].id, oxfordUser.profile.id, 401, function() {

                                                    // Global admins can subscribe users
                                                    TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                                        SeriesTestUtil.assertSubscribeSeries(globalAdminClient, series[2].id, camUser.profile.id, function() {
                                                            return callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that the user is defaulted to the current user when subscribing to a serie
         */
        it('verify the user is defaulted to the current user when subscribing to a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestUtil.generateSerieWithEvents(serieCreator.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Subscribe to the serie, but don't specify a user
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, null, function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that a user can subscribe to a serie without any events
         */
        it('verify a user can subscribe to a serie without any events', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie
                SeriesTestUtil.assertCreateSerie(serieCreator.client, 'Test serie', {}, function(serie) {

                    // Subscribe to the serie
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, serieSubscriber.profile.id, function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that calendars are updated when an event gets added or removed from a serie
         */
        it('verify calendars are updated when an event gets added to or removed from a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie
                SeriesTestUtil.assertCreateSerie(serieCreator.client, 'Test serie', {}, function(serie) {

                    // Subscribe to the serie
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, serieSubscriber.profile.id, function() {

                        // Add an event to the serie
                        var start = moment().format();
                        var end = moment().add(2, 'hour').format();
                        EventsTestsUtil.assertCreateEvent(serieCreator.client, 'Test event', start, end, null, function(event) {
                            SeriesTestUtil.assertAddSeriesEvents(serieCreator.client, serie.id, [event.id], function() {

                                // Ensure the calendar contains the event
                                UsersTestsUtil.assertGetUserCalendar(serieSubscriber.client, serieSubscriber.profile.id, start, end, [event], function() {

                                    // Remove the event from the serie
                                    SeriesTestUtil.assertDeleteSeriesEvents(serieCreator.client, serie.id, [event.id], function() {

                                        // Ensure the calendar no longer contains the event
                                        UsersTestsUtil.assertGetUserCalendar(serieSubscriber.client, serieSubscriber.profile.id, start, end, [], function(calendar) {
                                            assert.strictEqual(calendar.results.length, 0);
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that calendars are updated when an event gets deleted from the system
         */
        it('verify calendars are updated when an event gets deleted from the system', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie
                SeriesTestUtil.assertCreateSerie(serieCreator.client, 'Test serie', {}, function(serie) {

                    // Subscribe to the serie
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, serieSubscriber.profile.id, function() {

                        // Add 2 events to the serie
                        var start = moment().format();
                        var end = moment().add(2, 'hour').format();
                        EventsTestsUtil.generateTestEvents(serieCreator.client, 2, start, end, function(events) {
                            SeriesTestUtil.assertAddSeriesEvents(serieCreator.client, serie.id, _.pluck(events, 'id'), function() {

                                // Ensure the calendar contains the events
                                var calendarStart = moment().subtract(1, 'day').format();
                                var calendarEnd = moment().add(4, 'day').format();
                                UsersTestsUtil.assertGetUserCalendar(serieSubscriber.client, serieSubscriber.profile.id, calendarStart, calendarEnd, events, function() {

                                    // Delete the first event from the system
                                    EventsTestsUtil.assertDeleteEvent(serieCreator.client, events[0].id, function() {

                                        // Ensure the calendar only contains the second
                                        UsersTestsUtil.assertGetUserCalendar(serieSubscriber.client, serieSubscriber.profile.id, calendarStart, calendarEnd, [events[1]], function(calendar) {
                                            assert.strictEqual(calendar.results.length, 1);
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Unsubscribing', function() {

        /**
         * Test that verifies that a user can subscribe from a serie
         */
        it('verify a user can unsubscribe from a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestUtil.generateSerieWithEvents(serieCreator.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Subscribe to the serie
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, serieSubscriber.profile.id, function() {

                        // Unsubscribe from the serie
                        SeriesTestUtil.assertUnsubscribeSeries(serieSubscriber.client, serie.id, serieSubscriber.profile.id, function() {
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when a user unsubscribes from a serie
         */
        it('verify validation when a user unsubscribes from a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {

                // Generate a test serie
                SeriesTestUtil.assertCreateSerie(simon.client, 'Test serie', {}, function(serie) {

                    // Invalid serie id
                    SeriesTestUtil.assertUnsubscribeSeriesFails(simon.client, 'Not a number', simon.profile.id, 400, function() {

                        // Unknown serie id
                        SeriesTestUtil.assertUnsubscribeSeriesFails(simon.client, -1, simon.profile.id, 404, function() {
                            SeriesTestUtil.assertUnsubscribeSeriesFails(simon.client, 234234234234, simon.profile.id, 404, function() {

                                // Invalid user id
                                SeriesTestUtil.assertUnsubscribeSeriesFails(simon.client, serie.id, 'Not a number', 400, function() {

                                    // Unknown user id
                                    SeriesTestUtil.assertUnsubscribeSeriesFails(simon.client, serie.id, -1, 404, function() {
                                        SeriesTestUtil.assertUnsubscribeSeriesFails(simon.client, serie.id, 234234234234, 404, function() {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when a user unsubscribes from a serie
         */
        it('verify authorization when a user unsubscribes from a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(camUser, anotherCamUser) {
                TestsUtil.generateTestUsers(global.tests.apps.oxford2014, 1, false, function(oxfordUser) {

                    // Generate some test series with some events on the cambridge app
                    var calendarStart = moment().subtract(1, 'day').format();
                    var calendarEnd = moment().add(30, 'day').format();
                    SeriesTestUtil.generateSerieWithEvents(camUser.client, 3, 10, calendarStart, calendarEnd, function(series) {

                        // Subscribe to all the series
                        SeriesTestUtil.assertSubscribeSeries(camUser.client, series[0].id, camUser.profile.id, function() {
                            SeriesTestUtil.assertSubscribeSeries(camUser.client, series[1].id, camUser.profile.id, function() {
                                SeriesTestUtil.assertSubscribeSeries(camUser.client, series[2].id, camUser.profile.id, function() {

                                    // Anonymous users cannot unsubscribe from a serie
                                    TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2013, function(anonymousClient) {
                                        SeriesTestUtil.assertUnsubscribeSeriesFails(anonymousClient, series[0].id, camUser.profile.id, 401, function() {

                                            // Users cannot unsubscribe other users
                                            SeriesTestUtil.assertSubscribeSeriesFails(anotherCamUser.client, series[0].id, camUser.profile.id, 401, function() {

                                                // Users cannot unsubscribe other users from other applications
                                                SeriesTestUtil.assertSubscribeSeriesFails(oxfordUser.client, series[0].id, camUser.profile.id, 401, function() {

                                                    // Users can unsubscribe themselves
                                                    SeriesTestUtil.assertUnsubscribeSeries(camUser.client, series[0].id, camUser.profile.id, function() {

                                                        // App admins can unsubscribe users
                                                        SeriesTestUtil.assertUnsubscribeSeries(global.tests.admins.cam2013.client, series[1].id, camUser.profile.id, function() {

                                                            // App admins cannot unsubscribe users from other applications
                                                            SeriesTestUtil.assertUnsubscribeSeriesFails(global.tests.admins.cam2013.client, series[1].id, oxfordUser.profile.id, 401, function() {

                                                                // Global admins can unsubscribe users
                                                                TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                                                    SeriesTestUtil.assertUnsubscribeSeries(globalAdminClient, series[2].id, camUser.profile.id, function() {
                                                                        return callback();
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that the user is defaulted to the current user when unsubscribing from a serie
         */
        it('verify the user is defaulted to the current user when unsubscribing from a serie', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 2, false, function(serieCreator, serieSubscriber) {

                // Generate a test serie with some events
                var calendarStart = moment().subtract(1, 'day').format();
                var calendarEnd = moment().add(30, 'day').format();
                SeriesTestUtil.generateSerieWithEvents(serieCreator.client, 1, 10, calendarStart, calendarEnd, function(series) {
                    var serie = series[0];

                    // Subscribe to the serie, but don't specify a user
                    SeriesTestUtil.assertSubscribeSeries(serieSubscriber.client, serie.id, null, function() {

                        // Unsubscribe from the serie, but don't specify a user
                        SeriesTestUtil.assertUnsubscribeSeries(serieSubscriber.client, serie.id, null, function() {
                            return callback();
                        });
                    });
                });
            });
        });
    });
});
