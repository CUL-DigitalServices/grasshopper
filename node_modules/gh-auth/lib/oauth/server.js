
var _ = require('lodash');
var oauth2orize = require('oauth2orize');
var passport = require('passport');
var util = require('util');

var AuthOauth = require('../oauth');
var AuthOauthDAO = require('./dao');

var server = oauth2orize.createServer();

server.exchange(oauth2orize.exchange.code({'userProperty': 'ghAuthInfo'}, function(ghAuthInfo, code, redirectUri, done) {
    if (_.isEmpty(ghAuthInfo) || _.isEmpty(ghAuthInfo.oauthClient)) {
        return done({'code': 401, 'msg': 'Not authorized to acquire an access token'});
    }

    return AuthOauth.exchangeAuthCode(ghAuthInfo.oauthClient, code, redirectUri, done);
}));

module.exports.token = [
    passport.authenticate(['oauth2-client-password'], {'session': false}),
    server.token(),
    server.errorHandler()
];
