
var _ = require('lodash');
var chance = new require('chance')();

var ALPHABET = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';

var generateClientSecret = module.exports.generateClientSecret = function() {
    return chance.string({'length': 256, 'pool': ALPHABET});
};

var generateAuthCode = module.exports.generateAuthCode = function() {
    return chance.string({'length': 16, 'pool': ALPHABET});
};

var generateAccessToken = module.exports.generateAccessToken = function() {
    return chance.string({'length': 256, 'pool': ALPHABET});
};

var transformClient = module.exports.transformClient = function(ctx, client) {
    var fields = ['AppId', 'id', 'displayName'];
    if (ctx.user.canAdmin(client.AppId)) {
        fields.push('redirectUri', 'secret', 'disabled', 'createdAt', 'updatedAt');
    }

    return _.pick(client, fields);
};

var transformAccessToken = module.exports.transformAccessToken = function(ctx, accessToken) {
    var fields = ['id', 'token', 'OauthClientId', 'UserId', 'User', 'createdAt', 'updatedAt'];

    // Transform the client if it was joined into the model
    if (accessToken.OauthClient) {
        accessToken.OauthClient = transformClient(ctx, accessToken.Client);
        fields.push('OauthClient');
    }

    return _.pick(accessToken, fields);
};
