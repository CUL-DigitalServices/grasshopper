/**
 * Copyright (c) 2014 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var assert = require('assert');
var TestsUtil = require('gh-tests');
var UsersTestsUtil = require('gh-users/tests/util');

var AuthTestsUtil = require('gh-auth/tests/util');

describe('Local user authentication', function() {

    describe('Login', function() {

        /**
         * Test that verifies that a user can log in
         */
        it('verify a user can log in', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.oxford2014, 1, false, function(simon) {

                // Get an anonymous client for the app
                TestsUtil.getAnonymousAppUserClient(global.tests.apps.oxford2014, function(anonymousClient) {

                    // The anonymous client should be able to log in
                    AuthTestsUtil.assertLogin(anonymousClient, simon.profile.email, simon.client.options.password, callback);
                });
            });
        });

        /**
         * Test that verifies validation when logging in
         */
        it('verify validation when logging in', function(callback) {
            // Get an anonymous client for the app
            TestsUtil.getAnonymousAppUserClient(global.tests.apps.oxford2014, function(anonymousClient) {

                // Using bad credentials should not allow a user to get authenticated
                AuthTestsUtil.assertLoginFails(anonymousClient, 'foo@foo.com', null, function() {
                    AuthTestsUtil.assertLoginFails(anonymousClient, null, 'password', function() {
                        AuthTestsUtil.assertLoginFails(anonymousClient, 'not an email', 'password', function() {
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a user needs the correct credentials to log in
         */
        it('verify a user needs the correct credentials to log in', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.oxford2014, 1, false, function(simon) {

                // Get an anonymous client for the app
                TestsUtil.getAnonymousAppUserClient(global.tests.apps.oxford2014, function(anonymousClient) {

                    // Using bad credentials should not allow a user to get authenticated
                    AuthTestsUtil.assertLoginFails(anonymousClient, simon.profile.email, 'wrong password', function() {
                        AuthTestsUtil.assertLoginFails(anonymousClient, 'non.existing@email.com', simon.client.options.password, function() {

                            // Using the correct credentials on the wrong application should not allow a user to get authenticated
                            TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2013, function(anonymousOtherAppClient) {
                                AuthTestsUtil.assertLoginFails(anonymousOtherAppClient, simon.profile.email, simon.client.options.password, function() {
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Logout', function() {

        /**
         * Test that verifies that a user can log out
         */
        it('verify a user can log out', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2013, 1, false, function(simon) {
                // Sanity-check the user is logged in
                UsersTestsUtil.assertGetMe(simon.client, function(me) {
                    assert.strictEqual(me.anon, false);

                    // Log out
                    AuthTestsUtil.assertLogout(simon.client, callback);
                });
            });
        });
    });
});
