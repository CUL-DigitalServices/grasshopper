/**
 * Copyright (c) 2014 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var assert = require('assert');

var TestsUtil = require('gh-tests/lib/util');

var UsersTestsUtil = require('./util');

describe('Users', function() {

    describe('Creating a user', function() {

        /**
         * Test that verifies that a user can be created
         */
        it('verify a user can be created', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(simon) {
                assert.ok(simon);

                UsersTestsUtil.assertGetMe(simon.client, function(me) {
                    assert.strictEqual(me.displayName, simon.profile.displayName);
                    return callback();
                });
            });
        });
    });

    describe('Getting a user', function() {

        /**
         * Test that verifies that a user can be retrieved
         */
        it('verify a user can be retrieved', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(simon) {

                UsersTestsUtil.assertGetUser(simon.client, simon.profile.id, function(user) {
                    UsersTestsUtil.assertUser(user, simon.profile, true);
                    return callback();
                });
            });
        });

        /**
         * Test that verifies validation when retrieving a user
         */
        it('verify validation when retrieving a user', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(simon) {

                UsersTestsUtil.assertGetUserFails(simon.client, 'Not a number', 400, function() {
                    UsersTestsUtil.assertGetUserFails(simon.client, -1, 404, function() {
                        UsersTestsUtil.assertGetUserFails(simon.client, 234234233, 404, function() {
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when retrieving a user
         */
        it('verify authorization when retrieving a user', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(camUser) {
                TestsUtil.generateTestUsers(global.tests.apps.oxford2013, 1, false, function(oxUser) {

                    // Users from other applications cannot be retrieved by regular users
                    UsersTestsUtil.assertGetUserFails(camUser.client, oxUser.profile.id, 401, function() {

                        // Users from other applications cannot be retrieved by application admins users
                        UsersTestsUtil.assertGetUserFails(global.tests.admins.cam2014.client, oxUser.profile.id, 401, function() {

                            // Users from other applications can be retrieved by global admins
                            TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                UsersTestsUtil.assertGetUser(globalAdminClient, oxUser.profile.id, function() {
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that personal information is not returned
         */
        it('verify personal information is not returned', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 2, false, function(simon, nico) {

                // Simon can view his own information
                UsersTestsUtil.assertGetUser(simon.client, simon.profile.id, function(user) {
                    UsersTestsUtil.assertUser(user, simon.profile, true);

                    // Nico can retrieve the profile but not the personal information
                    UsersTestsUtil.assertGetUser(nico.client, simon.profile.id, function(user) {
                        UsersTestsUtil.assertUser(user, simon.profile, false);

                        // An application administrator from the same app can view Simon's personal information
                        UsersTestsUtil.assertGetUser(global.tests.admins.cam2014.client, simon.profile.id, function(user) {
                            UsersTestsUtil.assertUser(user, simon.profile, true);

                            // A global admin can see Simon's personal information
                            TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                UsersTestsUtil.assertGetUser(globalAdminClient, simon.profile.id, function(user) {
                                    UsersTestsUtil.assertUser(user, simon.profile, true);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Updating a user', function() {

        /**
         * Test that verifies that a user can be updated
         */
        it('verify a user can be updated', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(simon) {
                assert.ok(simon);

                // Update the user
                var update = {
                    'displayName': 'Simon',
                    'email': TestsUtil.generateTestEmailAddress()
                };
                UsersTestsUtil.assertUpdateUser(simon.client, simon.profile.id, update, function(updatedUser) {

                    // Verify the update has been persisted
                    UsersTestsUtil.assertGetMe(simon.client, function(me) {
                        assert.strictEqual(me.displayName, update.displayName);
                        assert.strictEqual(me.email, update.email);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies validation when updating a user
         */
        it('verify validation when updating a user', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 1, false, function(simon) {

                // Invalid user id
                UsersTestsUtil.assertUpdateUserFails(simon.client, 'Not a number', {'displayName': 'bleh'}, 400, function() {
                    // Unknown user id
                    UsersTestsUtil.assertUpdateUserFails(simon.client, -1, {'displayName': 'bleh'}, 404, function() {

                        // Missing update parameters
                        UsersTestsUtil.assertUpdateUserFails(simon.client, simon.profile.id, {}, 400, function() {

                            // Unknown update parameter
                            UsersTestsUtil.assertUpdateUserFails(simon.client, simon.profile.id, {'foo': 'bar'}, 400, function() {

                                // Missing value
                                UsersTestsUtil.assertUpdateUserFails(simon.client, simon.profile.id, {'displayName': null}, 400, function() {

                                    // Invalid parameters
                                    UsersTestsUtil.assertUpdateUserFails(simon.client, simon.profile.id, {'email': 'not an email address'}, 400, function() {
                                        UsersTestsUtil.assertUpdateUserFails(simon.client, simon.profile.id, {'emailPreference': 'lolwhat'}, 400, function() {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when updating a user
         */
        it('verify authorization when updating a user', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 2, false, function(simon, nico) {
                assert.ok(simon);

                // Update the user
                var update = {
                    'displayName': 'Simon',
                    'email': TestsUtil.generateTestEmailAddress()
                };

                // Anonymous users can't update other users
                TestsUtil.getAnonymousAppUserClient(global.tests.apps.cam2014, function(anonymousClient) {
                    UsersTestsUtil.assertUpdateUserFails(anonymousClient, simon.profile.id, update, 401, function() {
                        TestsUtil.getAnonymousGlobalAdminRestClient(function(anonymousGlobalAdminClient) {
                            UsersTestsUtil.assertUpdateUserFails(anonymousGlobalAdminClient, simon.profile.id, update, 401, function() {

                                // Regular users can't update other users
                                UsersTestsUtil.assertUpdateUserFails(nico.client, simon.profile.id, update, 401, function() {

                                    // Application admins can't update users from other applications
                                    UsersTestsUtil.assertUpdateUserFails(global.tests.admins.oxford2013.client, simon.profile.id, update, 401, function() {

                                        // Users can update their own profile
                                        UsersTestsUtil.assertUpdateUser(simon.client, simon.profile.id, update, function() {

                                            // App admins can update users from their application
                                            UsersTestsUtil.assertUpdateUser(global.tests.admins.cam2014.client, simon.profile.id, update, function() {

                                                // Global admins can update users
                                                TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
                                                    UsersTestsUtil.assertUpdateUser(globalAdminClient, simon.profile.id, update, function() {

                                                        return callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a user cannot use another user's email address
         */
        it('verify a user cannot use another user\'s email address', function(callback) {
            TestsUtil.generateTestUsers(global.tests.apps.cam2014, 2, false, function(simon, nico) {

                // Nico shouldn't be able to re-use Simon's email address
                UsersTestsUtil.assertUpdateUserFails(nico.client, nico.profile.id, {'email': simon.profile.email}, 400, function() {
                    return callback();
                });
            });
        });
    });
});
